[{"id":"3393a77f.f5daa8","type":"tab","label":"Puppet Show 93ea28f","disabled":false,"info":""},{"id":"25e0c6e7.7b804a","type":"tab","label":"Puppet Show","disabled":false,"info":""},{"id":"53ede10e.62c14","type":"tab","label":"Puppet Show 008a9d4","disabled":false,"info":""},{"id":"5e038606.189078","type":"tab","label":"Home","disabled":false,"info":""},{"id":"8743a80b.8df4a8","type":"tab","label":"1BetPro","disabled":false,"info":""},{"id":"363f279c.1671a8","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"","keyname":"","caname":"","verifyservercert":false},{"id":"8f853068.0d7cf","type":"google-credentials-youtube","z":"","displayName":"Avi Gershon"},{"id":"c21e0590.e618e8","type":"google-config","z":""},{"id":"fc09f44f.92f2b8","type":"google-conn","z":"","name":"Google","key":"{\n  \"type\": \"service_account\",\n  \"project_id\": \"datagram-195019\",\n  \"private_key_id\": \"8ec249401542e722a4eb8a76df15c83d3df4553e\",\n  \"private_key\": \"-----BEGIN PRIVATE KEY-----\\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDDKThvOjzrbL5m\\nF4ZdzqHFZAlhWyy/7Tr1mcLLo1efsXBbtInKgb+yCAk02zORKbYNNUU6dMPbJRIs\\ngYAyqsXVhlU9o/F4/oUIyPpiP2sWU/sRLHao4eyhndlo5lgYbmPOU9/tLIJTuKTR\\nH7j122JcCaX8suGuFlRvYeeH4LOCl9BHCHw1b2xj4oKv63UM3qtl0jIUDV6z+NaA\\nBNDDmP7igWZQoPoIvgRTVTFfq9GvhP0DD17cHFe1h7tcv1HkGImrgqmSx349MRaH\\nooU99WQD5hYzhNTls2IznIAppP1bDF7+5Ww1/DRGmt+13W42kV8Pg1VBWAGcZbim\\ngvvSzBDlAgMBAAECggEAANjidlUl442+y9mpSyn0+NLk2YfYS2L/wQYwWsr0O+y8\\nxKElgfwLNX4kcBbNhAFO2YLUMJtGKGLiT9AmGtIz9qfVIeXey/wq3q1krN2CnP+z\\nVNFBGJ2WdeMmCPcLBdwg0cn6bGCnli50hLXjCyovJKAkGNM7+JH/PtaJd0UJ8nSt\\nUVZb/Mfy/IZAEkirlQAZR4wQNBSCEYm8f+T8MVyVtUbniFCrCQza5aDvXMF/2K6w\\nSdzsrui6AFhkZEBBdgSaMUvL8MV/ScSkX6+R4x8ctWMYs1HpZ/cQI5TINurX5Ezb\\nf/YOzRuxha0YY86N14y+zJWNEHx8I8wCZhH94Yaf4QKBgQDk7ZUGAY7xFclqNDW1\\njQR27j+6YXxkPTyTWOhaT2qJqIm5L+z2YsFbIZR9ADJyfFkbJWaBfvX9p89kpNBI\\nLT48ah/iGEsuDfgbFKSvh7qvspyfaoghLwFF7ZTbYgrOxhsI44XIx/v2YAhQcjhN\\nPp9yaYVanxdLaZ/Cr+8dV5FsMQKBgQDaPWWsENc+JAsP53iuP81bBzxPE46YV2rL\\nW8PAYJXf+uDm+AfVHGmWUAxMRYDtqJEjga+SYNSMYQy1hWk5KJ+frkY4y4abh+sF\\nDVyzWKXvtOSa2m7GuIXs5yte3SVgZJPvPYPYXrVwaH3N49073qvfwR8jitAexjXQ\\nGVHGnsRm9QKBgFaYH+SztjQvf46yzRYtj2DFYknIEluAZmd+G/X9UFld7SqlnEbe\\nuDEWlKpr5qkzrCj+jrWxJq+aSHLTfQ2wP3hu1Dyb3+Q92Hm1502WU+Gd+Gy8yV10\\nAFFJOyN5BImOmi9UkQiPzRk23i4/5lghtgJ7M7xBrXgTLiFgl1xMAXAhAoGBAMM/\\n1NupQXjl9EOpWm3CxS3gflNc8uFWrEP9+Fb/0nbN1DKvywod3lVNjoMaV6vIePlk\\nSDjUirSBC0bHcgliT9UjrM2ZQPebFWeyubH26JZZp4DnVd5SLfdyJno7rfncYgHT\\nbkbBDODhi1QNvduXbvvDouFAisxNls10KZZiauKVAoGBANmtPGK/dwoj4Is84nfw\\noGwYJTbbBbNmGN4PHiA4a0ugcRm6jb8HOoivMTw0Eaej2K6UoZ3SCMl3Riu+iZiH\\n8GMHjcvuqViGjDMxW02ejx3cp/3QCVsSAxbh/YtXgF8wnVUHOsVJnOYfSlKOpUfV\\nFxiq7UVHY8hAL1Of+n1ixPAs\\n-----END PRIVATE KEY-----\\n\",\n  \"client_email\": \"api-service-account@datagram-195019.iam.gserviceaccount.com\",\n  \"client_id\": \"103865220578077617827\",\n  \"auth_uri\": \"https://accounts.google.com/o/oauth2/auth\",\n  \"token_uri\": \"https://accounts.google.com/o/oauth2/token\",\n  \"auth_provider_x509_cert_url\": \"https://www.googleapis.com/oauth2/v1/certs\",\n  \"client_x509_cert_url\": \"https://www.googleapis.com/robot/v1/metadata/x509/api-service-account%40datagram-195019.iam.gserviceaccount.com\"\n}","scopes":"https://www.googleapis.com/auth/youtube\nhttps://www.googleapis.com/auth/youtube.force-ssl\nhttps://www.googleapis.com/auth/youtube.readonly\nhttps://www.googleapis.com/auth/youtube.upload\nhttps://www.googleapis.com/auth/youtubepartner\nhttps://www.googleapis.com/auth/youtubepartner-channel-audit"},{"id":"43749542.37d54c","type":"remote-server","z":"","name":"elastic","host":"http://elasticsearch.default.svc.cluster.local:9200","port":"9200"},{"id":"151d107c.6f1aa","type":"debug","z":"25e0c6e7.7b804a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":950,"y":280,"wires":[]},{"id":"20d8b05a.fe4ba","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":250,"y":160,"wires":[["2cfee123.0f07ee"]]},{"id":"15533bd8.282f44","type":"function","z":"25e0c6e7.7b804a","name":"query Selectors","func":"'use strict';\n\nmsg.topic = \"1betpro\";\n\n//For Debuging with injection and without kafka\nif(msg.payload.value!==undefined){\n    msg.payload = msg.payload.value;\n}\nelse{\n    msg.payload.value = msg.payload;\n}\n//End Debugging\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    /*result = await page.evaluate(async (queries) => {\n      new Promise((resolve, reject) => {\n        try {\n\n            queries.filter(query => query.enabled).map(query => {\n                \n                attributes = function (e){\n                    return Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n                }\n                \n                query.result = Array.from(document.querySelectorAll(query.selector)).map(eval(query.pageFunction));\n                return query;\n            });\n\n            if(queries.length>0) resolve();\n            \n        } catch (error) {\n            console.log(\"error!!!!\")\n          reject(error);\n        }\n      }).catch(error => {\n        console.log(\"error!!!!\") // add catch here\n        //console.error(error) // add catch here\n      })\n    }, msg.payload.value.queries);\n    */\n    \n    result = await page.evaluate(queries => {\n        \n        var attributes = function (e){\n            \n            result = Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n            result.push({name: 'innerText', value: e.innerText});\n            result.push({name: 'innerHTML', value: e.innerHTML});\n            result.push({name: 'outerHTML', value: e.outerHTML});\n            \n            return result;\n        }\n        \n        var groupBy = function(xs, key) {\n            return xs.reduce(function(rv, x) {\n                (rv[x[key]] = rv[x[key]] || []).push(x);\n                return rv;\n            }, {});\n        };\n            \n        var select = function(e) {\n            \n            queries = e.queries;\n            e.data = [];\n            \n            if(e.document===undefined) e.document = document;\n            \n            queries.filter(query => query.enabled).forEach(query => {\n        \n                query_result =[];\n                \n                try{\n                    \n                    if(query.selector!==undefined){\n                        query.selected = true;\n                        if(query.pageFunction===undefined){\n                            query_result = Array.from(e.document.querySelectorAll(query.selector));\n                        }\n                        else{\n                            query.mapped = true;\n                            query_result = Array.from(e.document.querySelectorAll(query.selector)).map(eval(query.pageFunction));\n                        }\n                        \n                        if(query.command!==undefined){\n                            query.modified = true;\n                            Array.from(e.document.querySelectorAll(query.selector)).forEach(eval(query.command));\n                        }\n                    }\n                    \n                    if(query.filter!==undefined){\n                        query.filtered = true;\n                        query_result = query_result.filter(eval(query.filter));\n                    }\n                    \n                    if(query.groupBy!==undefined){\n                        query.grouped = true;\n                        query_result = groupBy(query_result, query.groupBy);\n                    }\n                    \n                    /*if(!Array.isArray(query.result)){\n                        query.result = new Array(query.result);\n                    }*/\n                    \n                    if((query.queries!==undefined || e.key!==undefined ) && query_result.length>0){\n                        \n                        query_result.map(child => {\n                            child.queries = query.queries;\n                            child.parent = (e.key!==undefined) ? e.key : null;\n                            if(query.queries!==undefined && query_result.length>0) select(child);\n                            \n                            //return child;\n                        });\n                    }\n                }\n                catch(error){\n                    console.error(error);\n                    query.error = error.message;\n                }\n                \n                e.data.push({query: query, data: query_result});\n                \n                return query;\n            })\n            \n            //e.data.push(queries);\n            return e;\n        }\n        \n        let e = {queries: queries};\n        \n        return select(e);\n        \n    },msg.payload.value.queries);\n    \n    \n    //Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n    msg.payload = result;\n    /*msg.payload = await page.evaluate({\n        return Array.from(document.querySelectorAll(results_selector));\n    });*/\n    \n    msg.topic = msg.topic + \"_extracted\";\n\n    node.send(msg);\n    \n        \n    \n\n    await browser.close();\n\n})();","outputs":1,"noerr":0,"x":460,"y":160,"wires":[["6d93887e.c57a98"]]},{"id":"fcf73cfd.bae76","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":160,"wires":[["20d8b05a.fe4ba"]]},{"id":"7ac484b7.34c5fc","type":"kafka producer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":1070,"y":660,"wires":[]},{"id":"ec67ce57.5fe5b","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":120,"y":280,"wires":[["2eb771d3.abcbee"]]},{"id":"2eb771d3.abcbee","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":490,"y":280,"wires":[["151d107c.6f1aa"]]},{"id":"8e8ed84d.848508","type":"inject","z":"25e0c6e7.7b804a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":80,"wires":[["a0fbec9e.347ae"]]},{"id":"a0fbec9e.347ae","type":"function","z":"25e0c6e7.7b804a","name":"prepare 1betpro message","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage'],\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : '.live_lines',//'tr.bets_lines td',\n        queries:[{\n                selector: \".live_lines\",\n                //name: \"live_lines\",\n                pageFunction : \"e => ({ document: e, key: 'live_lines'})\",\n                args: [],\n                enabled: true,\n                queries:[{\n                    selector: \".live_lines div[league_id]\",\n                    //name: \"leagues\",\n                    pageFunction : \"e => ({document: e, type: 'league', key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                    args: [],\n                    enabled: true,\n                    queries:[{\n                        selector: \".teams\",\n                        //name: \"teams\",\n                        pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, index :index})\",\n                        //filter: \"line => line.index % 3 === 0\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true            \n                    },{\n                        selector: \".bets_lines\",\n                        //name: \"lines\",\n                        pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, index :index})\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true\n                    }]\n                }],\n            },{\n                selector: \".live_lines div[league_id]\",\n                pageFunction : \"e => ({type: 'league', innerHTML: e.innerHTML, key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                args: [],\n                enabled: false,\n                queries:[{\n                    selector: \".teams\",\n                    pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: e.parent.key, index :index})\",\n                    //filter: \"line => line.index % 3 === 0\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false            \n                },{\n                    selector: \".bets_lines\",\n                    pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, league_id: e.parent, index :index})\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false\n                }]\n            },{\n                selector: \".live_lines > table .head_line_bottom b\",\n                pageFunction : \"e => ({type: 'league', name: e.innerText})\",\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .bets_lines\",\n                pageFunction : \"(e ,index) => ({type :'line', row: e.innerText.split('\\\\t')[0], index :index})\",\n                groupBy: 'number',\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .teams\",\n                pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value,index :index})\",\n                //filter: \"line => line.index % 3 === 0\",\n                groupBy: 'number',\n                args: [],\n                enabled: false            \n            }],\n        models: \n            [{\n                key : \"LiveLine\",\n                selector: \".live_lines\",\n                value: \"outerHTML\",\n                models: [{\n                    key : \"League\",\n                    selector : \"div[league_id]\",\n                    value: \"league_id\",\n                    fields: [{\n                        key : \"name\",\n                        selector : \".head_line_bottom b\",\n                        value: \"textContent\"\n                    }]\n                }]\n            }],\n        reduce_selector : '.head_line_bottom b',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[["2cfee123.0f07ee"]]},{"id":"c0854aa1.d7d978","type":"kafka producer","z":"25e0c6e7.7b804a","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":920,"y":80,"wires":[]},{"id":"6d93887e.c57a98","type":"switch","z":"25e0c6e7.7b804a","name":"1betpro","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1betpro_extracted","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":160,"wires":[["151d107c.6f1aa"]]},{"id":"4bcd4375.8f581c","type":"function","z":"25e0c6e7.7b804a","name":"Aggregate","func":"const fixed_number_of_total_td_in_tr = 10;\nconst start_from_td = 2;\nanchors = msg.payload;\n\naggregated_rows = [];\n\nfor (i = start_from_td; i < anchors.length; i+fixed_number_of_total_td_in_tr) {\n    \n    try{\n        const anchor = anchors[i];\n        \n        row = {};\n        \n        row.team  = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[1].split(\">\")[anchor.innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n        row.score = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[0].split(\">\")[anchor.innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n          \n        aggregated_rows.push(row); \n    }\n    catch(e){\n        \n    }\n}\n\nmsg = {\n    topic: \"1betpro_aggregated\",\n    payload : aggregated_rows\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":640,"wires":[["151d107c.6f1aa"]]},{"id":"bbe0460c.a8cb38","type":"catch","z":"25e0c6e7.7b804a","name":"","scope":null,"x":100,"y":380,"wires":[["3faddb54.b39bc4"]]},{"id":"15755a87.2b8635","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":470,"y":460,"wires":[["3faddb54.b39bc4"]]},{"id":"b6b2ec59.a695d","type":"kafka producer","z":"25e0c6e7.7b804a","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":930,"y":380,"wires":[]},{"id":"b54fdd71.b18a8","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":460,"wires":[["15755a87.2b8635"]]},{"id":"3faddb54.b39bc4","type":"debug","z":"25e0c6e7.7b804a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":920,"y":460,"wires":[]},{"id":"5f2dbc78.fb1c94","type":"function","z":"25e0c6e7.7b804a","name":"query Selectors 1.0","func":"'use strict'; \nmsg.topic = \"1betpro\";\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    // Extract the results from the page.\n    rows = await page.evaluate(results_selector => {\n        \n        //Extract\n        anchors = Array.from(document.querySelectorAll(results_selector));\n        \n        \n        //Transform\n        return anchors.map((anchor, index, array) => {\n            row = {};\n                \n            row.fixed_number_of_total_td_in_tr = 10;\n            row.array_length = array.length;\n            \n            row.index = index;\n            row.event_number = Math.floor(row.index/10);\n            row.textContent = `${anchor.textContent}`;\n            row.innerHTML = `${anchor.innerHTML}`;\n            \n            if(`${anchor.id}`!==\"\"){\n                row.id = `${anchor.id}`;\n                \n                row.team_anchor_index = (row.event_number*10);\n                \n                //team_anchor = array[team_anchor_index];\n                \n                //console.log(team_anchor);\n                \n                //row.team_innerHTML = `${team_anchor.innerHTML}`;\n                \n                row.source = anchor;\n                \n                row.elements = row.innerHTML.split(\"</\");\n                //custom transformation\n                row.id_parts = row.id.split(\"_\");\n                row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n                row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n                row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n                row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n                row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n                \n                //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n                //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n                  \n                row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n                \n                row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n                row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n                \n                row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n        \n                row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n        \n                //console.log(row);\n            //}\n            //catch(e){\n                \n            //}\n            }\n            \n            return row;\n            \n        });\n    }, msg.payload.value.results_selector);\n  \n    msg.topic = msg.topic + \"_extracted\";\n    \n    msg.payload = await rows.reduce((all, one) =>{\n        \n        if(!Array.isArray(all)){\n            all = [];\n        }\n        \n        result = all[one.event_number];\n        \n        console.log(result);\n        \n        if (result === undefined) {\n            // not found\n            one.all = [];\n            all.splice(one.event_number, 0, one);\n        }  else {\n            // multiple items found\n            result.all.splice(one.event_number, 0, one);\n        }\n        \n        return all;\n    });\n    \n    node.send(msg);\n    //console.log(rows.join('\\n'));\n    //console.log(rows);\n  \n    browser.close();\n})();","outputs":1,"noerr":0,"x":370,"y":560,"wires":[[]]},{"id":"ddf233b7.569e8","type":"html","z":"25e0c6e7.7b804a","name":"","property":"payload.innerHTML","tag":"","ret":"html","as":"multi","x":790,"y":160,"wires":[["c85cc2ae.ad0ad"]]},{"id":"c85cc2ae.ad0ad","type":"debug","z":"25e0c6e7.7b804a","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":960,"y":160,"wires":[]},{"id":"5b8b5869.7e75c8","type":"function","z":"25e0c6e7.7b804a","name":"","func":"//Extract\n        function map_document(doc, models){\n        \n            return models.map(model=> {\n                \n                model.rows = [];\n                \n                anchors = Array.from(doc.querySelectorAll(model.selector));\n                    \n                anchors.forEach((anchor) => {\n                    row = {};\n                    row.messages = [];\n                    \n                    row.key = model.key;\n                    row.selector = model.selector;\n                    \n                    row.attributes = Array.from(anchor.attributes).map(someAt => ({name: someAt.name, value: someAt.value}))\n                    row.attributes.push({name: \"textContent\", value: `${anchor.textContent}`});\n                    row.attributes.push({name: \"innerHTML\", value: `${anchor.innerHTML}`});\n                    row.attributes.push({name: \"outerHTML\", value: `${anchor.outerHTML}`});\n                    row.value = null;\n                    \n                    if(model.hasOwnProperty(\"value\")){\n                        row.messages.push(\"model \" + model.key + \" has value\");\n                        row.attribute = row.attributes.find(o => o.name === model.value);\n                        if(row.attribute!==undefined) row.value = row.attribute.value;\n                    }\n                    \n                    if(model.hasOwnProperty(\"models\")){\n                        row.messages.push(\"model \" + model.key + \" has models\");\n                        map_document(anchor, model.models);\n                    }\n                    \n                    if(model.hasOwnProperty(\"fields\")){\n                        row.messages.push(\"model \" + model.key + \" has fields\");\n                        map_document(anchor, model.fields);\n                    }\n                    \n                    model.rows.push(row);\n                });\n                \n                return model;\n                \n            });\n        }\n\n        return map_document(document, models);\n        /*return maps.map(map=> {\n            \n            if(map.anchor===undefined) map.anchor = document;\n            \n            anchors = Array.from(map.anchor.querySelectorAll(map.selector));\n            \n            return anchors.map((anchor, index, array) => {\n                row = {};\n                \n                row.textContent = `${anchor.textContent}`;\n                row.innerHTML = `${anchor.innerHTML}`;\n                //row.outerHTML = `${anchor.outerHTML}`;\n                row.innerJson = `${anchor.innerHTML}`;\n                \n                if(map.hasOwnProperty(\"selectors\")){\n                    \n                }\n                \n                return row;\n            });\n            \n        });*/\n        \nreturn msg;","outputs":1,"noerr":0,"x":180,"y":640,"wires":[[]]},{"id":"c447469c.b004c8","type":"debug","z":"3393a77f.f5daa8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":950,"y":280,"wires":[]},{"id":"213ec4bd.2f146c","type":"json","z":"3393a77f.f5daa8","name":"","property":"payload.value","action":"","pretty":true,"x":250,"y":160,"wires":[["379763c7.beda6c"]]},{"id":"379763c7.beda6c","type":"function","z":"3393a77f.f5daa8","name":"query Selectors","func":"'use strict';\n\nmsg.topic = \"1betpro\";\n\nif(msg.payload.value!==undefined){\n    msg.payload = msg.payload.value;\n}\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.url);\n    \n    await page.type(msg.payload.username_selector, msg.payload.username);\n    await page.type(msg.payload.password_selector, msg.payload.password);\n    \n    await page.waitForSelector(msg.payload.login_button_selector);\n    \n    await page.click(msg.payload.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.logout_user_selector);\n    \n    await page.goto(msg.payload.next_url);\n    \n    await page.waitForSelector(msg.payload.wait_for_selector);\n    \n    /*result = await page.evaluate(async (queries) => {\n      new Promise((resolve, reject) => {\n        try {\n\n            queries.filter(query => query.enabled).map(query => {\n                \n                attributes = function (e){\n                    return Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n                }\n                \n                query.result = Array.from(document.querySelectorAll(query.selector)).map(eval(query.pageFunction));\n                return query;\n            });\n\n            if(queries.length>0) resolve();\n            \n        } catch (error) {\n            console.log(\"error!!!!\")\n          reject(error);\n        }\n      }).catch(error => {\n        console.log(\"error!!!!\") // add catch here\n        //console.error(error) // add catch here\n      })\n    }, msg.payload.value.queries);\n    */\n    \n    await msg.payload.queries.filter(query => query.enabled).map(query => {\n        \n        try{\n            \n            query = page.evaluate(query => {\n                \n                var attributes = function (e){\n            \n                    result = Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n                    result.push({name: 'innerText', value: e.innerText});\n                    result.push({name: 'innerHTML', value: e.innerHTML});\n                    result.push({name: 'outerHTML', value: e.outerHTML});\n                    \n                    return result;\n                }\n                \n                var select = function(query) {\n                    \n                    if(query.document===undefined) query.document = document;\n                    \n                    query.result =[];\n                    \n                    if(query.selector!==undefined){\n                            \n                        query.selected = true;\n                        query.result = Array.from(query.document.querySelectorAll(query.selector));\n        \n                        if(query.result.length>0){\n                            \n                            if(query.transform!==undefined){\n                                query.transformed = true;\n                                query.result.map(eval(query.transform));\n                                \n                                if((query.queries!==undefined || e.key!==undefined ) && query.result.length>0){\n                            \n                                    query.result.map(row => {\n                                        \n                                        row.parent = (e.key!==undefined) ? e.key : null;\n                                        row.queries;\n                                        \n                                        return select(row);\n                                        \n                                    });\n                                }\n                            }\n                            \n                        }\n                        \n                    }\n                    \n                    return query;\n                }\n                \n                return select(query);\n                \n            },query);\n            \n        }\n        catch(error){\n            console.error(error);\n            query.error = error.message;\n        }\n          \n        \n    });\n    \n    \n    /*\n    node.send({\n                topic : \"QUERY_RESULTS_RETURNED\",\n                payload: result,\n                timestamp: new Date().toISOString()\n            });\n    result = await page.evaluate(queries => {\n        \n        var attributes = function (e){\n            \n            result = Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n            result.push({name: 'innerText', value: e.innerText});\n            result.push({name: 'innerHTML', value: e.innerHTML});\n            result.push({name: 'outerHTML', value: e.outerHTML});\n            \n            return result;\n        }\n        \n        var groupBy = function(xs, key) {\n            return xs.reduce(function(rv, x) {\n                (rv[x[key]] = rv[x[key]] || []).push(x);\n                return rv;\n            }, {});\n        };\n            \n        var select = function(e, queries) {\n            \n            if(e.document===undefined) e.document = document;\n            \n            return queries.filter(query => query.enabled).map(query => {\n        \n                query.result =[];\n                \n                try{\n                    \n                    if(query.selector!==undefined){\n                        \n                        query.selected = true;\n                        query.result = Array.from(e.document.querySelectorAll(query.selector));\n\n                        if(query.result.length>0 && query.transform!==undefined){\n                            \n                            query.transformed = true;\n                            query.result.map(eval(query.transform));\n                            \n                            if((query.queries!==undefined || e.key!==undefined ) && query.result.length>0){\n                        \n                                query.result.map(child => {\n                                    \n                                    child.parent = (e.key!==undefined) ? e.key : null;\n                                    if(query.queries!==undefined && query.result.length>0) select(child, query.queries);\n                                    \n                                });\n                            }\n                        }\n                    }\n                    \n                }\n                catch(error){\n                    console.error(error);\n                    query.error = error.message;\n                }\n                \n                return query;\n            })\n            \n        }\n        \n        return select({}, queries);\n        \n    },msg.payload.value.queries);\n    */\n    \n    msg.topic = msg.topic + \"_extracted\";\n    node.send(msg);\n\n    await browser.close();\n\n})();","outputs":1,"noerr":0,"x":460,"y":160,"wires":[["e2a10dd1.2ca6c"]]},{"id":"81d78f27.b8d3e","type":"kafka consumer","z":"3393a77f.f5daa8","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":160,"wires":[["213ec4bd.2f146c"]]},{"id":"757d1152.a7336","type":"kafka producer","z":"3393a77f.f5daa8","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":1070,"y":660,"wires":[]},{"id":"5c72fd17.6c3944","type":"kafka consumer","z":"3393a77f.f5daa8","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":120,"y":280,"wires":[["7c1e4142.26d2d"]]},{"id":"7c1e4142.26d2d","type":"json","z":"3393a77f.f5daa8","name":"","property":"payload.value","action":"","pretty":true,"x":490,"y":280,"wires":[["c447469c.b004c8"]]},{"id":"ad6a50de.0c943","type":"inject","z":"3393a77f.f5daa8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":80,"wires":[["382c15f8.0078aa"]]},{"id":"382c15f8.0078aa","type":"function","z":"3393a77f.f5daa8","name":"prepare 1betpro message","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage'],\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : '.live_lines',//'tr.bets_lines td',\n        queries:[{\n                selector: \".live_lines\",\n                transform : \"e => ({ document: e, key: 'live_lines'})\",\n                args: [],\n                enabled: true,\n                queries:[{\n                    selector: \".live_lines div[league_id]\",\n                    transform : \"e => ({document: e, type: 'league', key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                    args: [],\n                    enabled: true,\n                    queries:[{\n                        selector: \".teams\",\n                        transform : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, index :index})\",\n                        args: [],\n                        enabled: true            \n                    },{\n                        selector: \".bets_lines\",\n                        transform : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, index :index})\",\n                        args: [],\n                        enabled: true\n                    }]\n                }],\n            },{\n                selector: \".live_lines div[league_id]\",\n                pageFunction : \"e => ({type: 'league', innerHTML: e.innerHTML, key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                args: [],\n                enabled: false,\n                queries:[{\n                    selector: \".teams\",\n                    pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: e.parent.key, index :index})\",\n                    //filter: \"line => line.index % 3 === 0\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false            \n                },{\n                    selector: \".bets_lines\",\n                    pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, league_id: e.parent, index :index})\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false\n                }]\n            },{\n                selector: \".live_lines > table .head_line_bottom b\",\n                pageFunction : \"e => ({type: 'league', name: e.innerText})\",\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .bets_lines\",\n                pageFunction : \"(e ,index) => ({type :'line', row: e.innerText.split('\\\\t')[0], index :index})\",\n                groupBy: 'number',\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .teams\",\n                pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value,index :index})\",\n                //filter: \"line => line.index % 3 === 0\",\n                groupBy: 'number',\n                args: [],\n                enabled: false            \n            }],\n        models: \n            [{\n                key : \"LiveLine\",\n                selector: \".live_lines\",\n                value: \"outerHTML\",\n                models: [{\n                    key : \"League\",\n                    selector : \"div[league_id]\",\n                    value: \"league_id\",\n                    fields: [{\n                        key : \"name\",\n                        selector : \".head_line_bottom b\",\n                        value: \"textContent\"\n                    }]\n                }]\n            }],\n        reduce_selector : '.head_line_bottom b',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[["379763c7.beda6c"]]},{"id":"58910ee.ea485f","type":"kafka producer","z":"3393a77f.f5daa8","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":920,"y":80,"wires":[]},{"id":"e2a10dd1.2ca6c","type":"switch","z":"3393a77f.f5daa8","name":"1betpro","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1betpro_extracted","vt":"str"},{"t":"eq","v":"QUERY_RESULTS_RETURNED","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":620,"y":160,"wires":[["c447469c.b004c8"],["c447469c.b004c8"]]},{"id":"7bdfc74d.2fdf88","type":"function","z":"3393a77f.f5daa8","name":"Aggregate","func":"const fixed_number_of_total_td_in_tr = 10;\nconst start_from_td = 2;\nanchors = msg.payload;\n\naggregated_rows = [];\n\nfor (i = start_from_td; i < anchors.length; i+fixed_number_of_total_td_in_tr) {\n    \n    try{\n        const anchor = anchors[i];\n        \n        row = {};\n        \n        row.team  = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[1].split(\">\")[anchor.innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n        row.score = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[0].split(\">\")[anchor.innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n          \n        aggregated_rows.push(row); \n    }\n    catch(e){\n        \n    }\n}\n\nmsg = {\n    topic: \"1betpro_aggregated\",\n    payload : aggregated_rows\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":640,"wires":[["c447469c.b004c8"]]},{"id":"a27e1bf4.e9e938","type":"catch","z":"3393a77f.f5daa8","name":"","scope":[],"x":100,"y":380,"wires":[["59a3dd80.04c874"]]},{"id":"8c771553.4393f8","type":"json","z":"3393a77f.f5daa8","name":"","property":"payload.value","action":"","pretty":true,"x":470,"y":460,"wires":[["59a3dd80.04c874"]]},{"id":"10ee8c78.54e274","type":"kafka producer","z":"3393a77f.f5daa8","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":930,"y":380,"wires":[]},{"id":"ad200e73.bd031","type":"kafka consumer","z":"3393a77f.f5daa8","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":460,"wires":[["8c771553.4393f8"]]},{"id":"59a3dd80.04c874","type":"debug","z":"3393a77f.f5daa8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":920,"y":460,"wires":[]},{"id":"ad303606.520a18","type":"function","z":"3393a77f.f5daa8","name":"query Selectors 1.0","func":"'use strict'; \nmsg.topic = \"1betpro\";\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    // Extract the results from the page.\n    rows = await page.evaluate(results_selector => {\n        \n        //Extract\n        anchors = Array.from(document.querySelectorAll(results_selector));\n        \n        //Transform\n        return anchors.map((anchor, index, array) => {\n            row = {};\n                \n            row.fixed_number_of_total_td_in_tr = 10;\n            row.array_length = array.length;\n            \n            row.index = index;\n            row.event_number = Math.floor(row.index/10);\n            row.textContent = `${anchor.textContent}`;\n            row.innerHTML = `${anchor.innerHTML}`;\n            \n            if(`${anchor.id}`!==\"\"){\n                row.id = `${anchor.id}`;\n                \n                row.team_anchor_index = (row.event_number*10);\n                \n                //team_anchor = array[team_anchor_index];\n                \n                //console.log(team_anchor);\n                \n                //row.team_innerHTML = `${team_anchor.innerHTML}`;\n                \n                row.source = anchor;\n                \n                row.elements = row.innerHTML.split(\"</\");\n                //custom transformation\n                row.id_parts = row.id.split(\"_\");\n                row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n                row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n                row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n                row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n                row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n                \n                //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n                //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n                  \n                row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n                \n                row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n                row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n                \n                row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n        \n                row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n        \n                //console.log(row);\n            //}\n            //catch(e){\n                \n            //}\n            }\n            \n            return row;\n            \n        });\n        \n    }, msg.payload.value.results_selector);\n  \n    msg.topic = msg.topic + \"_extracted\";\n    \n    msg.payload = await rows.reduce((all, one) =>{\n        \n        if(!Array.isArray(all)){\n            all = [];\n        }\n        \n        result = all[one.event_number];\n        \n        console.log(result);\n        \n        if (result === undefined) {\n            // not found\n            one.all = [];\n            all.splice(one.event_number, 0, one);\n        }  else {\n            // multiple items found\n            result.all.splice(one.event_number, 0, one);\n        }\n        \n        return all;\n    });\n    \n    node.send(msg);\n    //console.log(rows.join('\\n'));\n    //console.log(rows);\n  \n    browser.close();\n})();","outputs":1,"noerr":0,"x":370,"y":560,"wires":[[]]},{"id":"b8ec696.5cb8a98","type":"html","z":"3393a77f.f5daa8","name":"","property":"payload.innerHTML","tag":"","ret":"html","as":"multi","x":790,"y":160,"wires":[["b94e2d3a.8151d"]]},{"id":"b94e2d3a.8151d","type":"debug","z":"3393a77f.f5daa8","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":960,"y":160,"wires":[]},{"id":"b85405d5.194368","type":"function","z":"3393a77f.f5daa8","name":"","func":"//Extract\n        function map_document(doc, models){\n        \n            return models.map(model=> {\n                \n                model.rows = [];\n                \n                anchors = Array.from(doc.querySelectorAll(model.selector));\n                    \n                anchors.forEach((anchor) => {\n                    row = {};\n                    row.messages = [];\n                    \n                    row.key = model.key;\n                    row.selector = model.selector;\n                    \n                    row.attributes = Array.from(anchor.attributes).map(someAt => ({name: someAt.name, value: someAt.value}))\n                    row.attributes.push({name: \"textContent\", value: `${anchor.textContent}`});\n                    row.attributes.push({name: \"innerHTML\", value: `${anchor.innerHTML}`});\n                    row.attributes.push({name: \"outerHTML\", value: `${anchor.outerHTML}`});\n                    row.value = null;\n                    \n                    if(model.hasOwnProperty(\"value\")){\n                        row.messages.push(\"model \" + model.key + \" has value\");\n                        row.attribute = row.attributes.find(o => o.name === model.value);\n                        if(row.attribute!==undefined) row.value = row.attribute.value;\n                    }\n                    \n                    if(model.hasOwnProperty(\"models\")){\n                        row.messages.push(\"model \" + model.key + \" has models\");\n                        map_document(anchor, model.models);\n                    }\n                    \n                    if(model.hasOwnProperty(\"fields\")){\n                        row.messages.push(\"model \" + model.key + \" has fields\");\n                        map_document(anchor, model.fields);\n                    }\n                    \n                    model.rows.push(row);\n                });\n                \n                return model;\n                \n            });\n        }\n\n        return map_document(document, models);\n        /*return maps.map(map=> {\n            \n            if(map.anchor===undefined) map.anchor = document;\n            \n            anchors = Array.from(map.anchor.querySelectorAll(map.selector));\n            \n            return anchors.map((anchor, index, array) => {\n                row = {};\n                \n                row.textContent = `${anchor.textContent}`;\n                row.innerHTML = `${anchor.innerHTML}`;\n                //row.outerHTML = `${anchor.outerHTML}`;\n                row.innerJson = `${anchor.innerHTML}`;\n                \n                if(map.hasOwnProperty(\"selectors\")){\n                    \n                }\n                \n                return row;\n            });\n            \n        });*/\n        \nreturn msg;","outputs":1,"noerr":0,"x":180,"y":640,"wires":[[]]},{"id":"2a866c63.f755a4","type":"debug","z":"53ede10e.62c14","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":950,"y":280,"wires":[]},{"id":"e9ccee2.8cb121","type":"json","z":"53ede10e.62c14","name":"","property":"payload.value","action":"","pretty":true,"x":250,"y":160,"wires":[["70805923.127288"]]},{"id":"70805923.127288","type":"function","z":"53ede10e.62c14","name":"query Selectors","func":"'use strict';\n\nmsg.topic = \"1betpro\";\n\n//For Debuging with injection and without kafka\nif(msg.payload.value!==undefined){\n    msg.payload = msg.payload.value;\n}\nelse{\n    msg.payload.value = msg.payload;\n}\n//End Debugging\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    /*result = await page.evaluate(async (queries) => {\n      new Promise((resolve, reject) => {\n        try {\n\n            queries.filter(query => query.enabled).map(query => {\n                \n                attributes = function (e){\n                    return Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n                }\n                \n                query.result = Array.from(document.querySelectorAll(query.selector)).map(eval(query.pageFunction));\n                return query;\n            });\n\n            if(queries.length>0) resolve();\n            \n        } catch (error) {\n            console.log(\"error!!!!\")\n          reject(error);\n        }\n      }).catch(error => {\n        console.log(\"error!!!!\") // add catch here\n        //console.error(error) // add catch here\n      })\n    }, msg.payload.value.queries);\n    */\n    \n    result = await page.evaluate(queries => {\n        \n        var attributes = function (e){\n            \n            result = Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n            result.push({name: 'innerText', value: e.innerText});\n            result.push({name: 'innerHTML', value: e.innerHTML});\n            result.push({name: 'outerHTML', value: e.outerHTML});\n            \n            return result;\n        }\n        \n        var groupBy = function(xs, key) {\n            return xs.reduce(function(rv, x) {\n                (rv[x[key]] = rv[x[key]] || []).push(x);\n                return rv;\n            }, {});\n        };\n            \n        var select = function(e, queries) {\n            \n            if(e.document===undefined) e.document = document;\n            \n            return queries.filter(query => query.enabled).map(query => {\n        \n                query.result =[];\n                \n                try{\n                    \n                    if(query.selector!==undefined){\n                        query.selected = true;\n                        if(query.pageFunction===undefined){\n                            query.result = Array.from(e.document.querySelectorAll(query.selector));\n                        }\n                        else{\n                            query.mapped = true;\n                            query.result = Array.from(e.document.querySelectorAll(query.selector)).map(eval(query.pageFunction));\n                        }\n                        \n                        if(query.command!==undefined){\n                            query.modified = true;\n                            Array.from(e.document.querySelectorAll(query.selector)).forEach(eval(query.command));\n                        }\n                    }\n                    \n                    if(query.filter!==undefined){\n                        query.filtered = true;\n                        query.result = query.result.filter(eval(query.filter));\n                    }\n                    \n                    if(query.groupBy!==undefined){\n                        query.grouped = true;\n                        query.result = groupBy(query.result, query.groupBy);\n                    }\n                    \n                    /*if(!Array.isArray(query.result)){\n                        query.result = new Array(query.result);\n                    }*/\n                    \n                    if((query.queries!==undefined || e.key!==undefined ) && query.result.length>0){\n                        \n                        query.result.map(child => {\n                            \n                            child.parent = (e.key!==undefined) ? e.key : null;\n                            if(query.queries!==undefined && query.result.length>0) child.result = select(child, query.queries);\n                            \n                            //return child;\n                        });\n                    }\n                }\n                catch(error){\n                    console.error(error);\n                    query.error = error.message;\n                }\n                \n                return query;\n            })\n            \n            //e.result.push(queries);\n        }\n        \n        var from = function(html){\n            \n            var parser = new DOMParser();\n            var doc = parser.parseFromString(html, \"text/html\");\n\n            //var doc = document.implementation.createHTMLDocument(\"doc\");\n            //doc.documentElement.innerHTML = html;\n            \n            return doc;\n        }\n        \n        return select({}, queries);\n        \n    },msg.payload.value.queries);\n    \n    \n    //Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n    msg.payload = result;\n    /*msg.payload = await page.evaluate({\n        return Array.from(document.querySelectorAll(results_selector));\n    });*/\n    \n    msg.topic = msg.topic + \"_extracted\";\n\n    node.send(msg);\n    \n        \n    \n\n    await browser.close();\n\n})();","outputs":1,"noerr":0,"x":460,"y":160,"wires":[["bc39213f.e7ac7"]]},{"id":"a8fb3ab1.513f98","type":"kafka consumer","z":"53ede10e.62c14","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":160,"wires":[["e9ccee2.8cb121"]]},{"id":"cb22e11e.4589f","type":"kafka producer","z":"53ede10e.62c14","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":1070,"y":660,"wires":[]},{"id":"cb702ed5.092cb","type":"kafka consumer","z":"53ede10e.62c14","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":120,"y":280,"wires":[["88013f10.9b6eb"]]},{"id":"88013f10.9b6eb","type":"json","z":"53ede10e.62c14","name":"","property":"payload.value","action":"","pretty":true,"x":490,"y":280,"wires":[["2a866c63.f755a4"]]},{"id":"4bc7bb17.a22a94","type":"inject","z":"53ede10e.62c14","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":80,"wires":[["feee50c5.8e348"]]},{"id":"feee50c5.8e348","type":"function","z":"53ede10e.62c14","name":"prepare 1betpro message","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage'],\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : '.live_lines',//'tr.bets_lines td',\n        queries:[{\n                selector: \".live_lines\",\n                pageFunction : \"e => ({ document: e, key: 'live_lines'})\",\n                args: [],\n                enabled: true,\n                queries:[{\n                    selector: \".live_lines div[league_id]\",\n                    pageFunction : \"e => ({document: e, type: 'league', key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                    args: [],\n                    enabled: true,\n                    queries:[{\n                        selector: \".teams\",\n                        pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, index :index})\",\n                        //filter: \"line => line.index % 3 === 0\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true            \n                    },{\n                        selector: \".bets_lines\",\n                        pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, index :index})\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true\n                    }]\n                }],\n            },{\n                selector: \".live_lines div[league_id]\",\n                pageFunction : \"e => ({type: 'league', innerHTML: e.innerHTML, key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                args: [],\n                enabled: false,\n                queries:[{\n                    selector: \".teams\",\n                    pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: e.parent.key, index :index})\",\n                    //filter: \"line => line.index % 3 === 0\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false            \n                },{\n                    selector: \".bets_lines\",\n                    pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, league_id: e.parent, index :index})\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false\n                }]\n            },{\n                selector: \".live_lines > table .head_line_bottom b\",\n                pageFunction : \"e => ({type: 'league', name: e.innerText})\",\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .bets_lines\",\n                pageFunction : \"(e ,index) => ({type :'line', row: e.innerText.split('\\\\t')[0], index :index})\",\n                groupBy: 'number',\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .teams\",\n                pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value,index :index})\",\n                //filter: \"line => line.index % 3 === 0\",\n                groupBy: 'number',\n                args: [],\n                enabled: false            \n            }],\n        models: \n            [{\n                key : \"LiveLine\",\n                selector: \".live_lines\",\n                value: \"outerHTML\",\n                models: [{\n                    key : \"League\",\n                    selector : \"div[league_id]\",\n                    value: \"league_id\",\n                    fields: [{\n                        key : \"name\",\n                        selector : \".head_line_bottom b\",\n                        value: \"textContent\"\n                    }]\n                }]\n            }],\n        reduce_selector : '.head_line_bottom b',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[["70805923.127288"]]},{"id":"55a35a2d.7f2544","type":"kafka producer","z":"53ede10e.62c14","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":920,"y":80,"wires":[]},{"id":"bc39213f.e7ac7","type":"switch","z":"53ede10e.62c14","name":"1betpro","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1betpro_extracted","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":160,"wires":[["2a866c63.f755a4"]]},{"id":"f465450f.67a968","type":"function","z":"53ede10e.62c14","name":"Aggregate","func":"const fixed_number_of_total_td_in_tr = 10;\nconst start_from_td = 2;\nanchors = msg.payload;\n\naggregated_rows = [];\n\nfor (i = start_from_td; i < anchors.length; i+fixed_number_of_total_td_in_tr) {\n    \n    try{\n        const anchor = anchors[i];\n        \n        row = {};\n        \n        row.team  = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[1].split(\">\")[anchor.innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n        row.score = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[0].split(\">\")[anchor.innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n          \n        aggregated_rows.push(row); \n    }\n    catch(e){\n        \n    }\n}\n\nmsg = {\n    topic: \"1betpro_aggregated\",\n    payload : aggregated_rows\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":640,"wires":[["2a866c63.f755a4"]]},{"id":"a68ba955.4b5dd8","type":"catch","z":"53ede10e.62c14","name":"","scope":null,"x":100,"y":380,"wires":[["ad2f5c3d.4de6b"]]},{"id":"e40e299c.8e3898","type":"json","z":"53ede10e.62c14","name":"","property":"payload.value","action":"","pretty":true,"x":470,"y":460,"wires":[["ad2f5c3d.4de6b"]]},{"id":"90c34cdb.25675","type":"kafka producer","z":"53ede10e.62c14","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":930,"y":380,"wires":[]},{"id":"6a39d481.43bf5c","type":"kafka consumer","z":"53ede10e.62c14","name":"errors","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"errors","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":460,"wires":[["e40e299c.8e3898"]]},{"id":"ad2f5c3d.4de6b","type":"debug","z":"53ede10e.62c14","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":920,"y":460,"wires":[]},{"id":"e0d36ec8.9c3ea","type":"function","z":"53ede10e.62c14","name":"query Selectors 1.0","func":"'use strict'; \nmsg.topic = \"1betpro\";\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    // Extract the results from the page.\n    rows = await page.evaluate(results_selector => {\n        \n        //Extract\n        anchors = Array.from(document.querySelectorAll(results_selector));\n        \n        \n        //Transform\n        return anchors.map((anchor, index, array) => {\n            row = {};\n                \n            row.fixed_number_of_total_td_in_tr = 10;\n            row.array_length = array.length;\n            \n            row.index = index;\n            row.event_number = Math.floor(row.index/10);\n            row.textContent = `${anchor.textContent}`;\n            row.innerHTML = `${anchor.innerHTML}`;\n            \n            if(`${anchor.id}`!==\"\"){\n                row.id = `${anchor.id}`;\n                \n                row.team_anchor_index = (row.event_number*10);\n                \n                //team_anchor = array[team_anchor_index];\n                \n                //console.log(team_anchor);\n                \n                //row.team_innerHTML = `${team_anchor.innerHTML}`;\n                \n                row.source = anchor;\n                \n                row.elements = row.innerHTML.split(\"</\");\n                //custom transformation\n                row.id_parts = row.id.split(\"_\");\n                row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n                row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n                row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n                row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n                row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n                \n                //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n                //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n                  \n                row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n                \n                row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n                row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n                \n                row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n        \n                row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n        \n                //console.log(row);\n            //}\n            //catch(e){\n                \n            //}\n            }\n            \n            return row;\n            \n        });\n    }, msg.payload.value.results_selector);\n  \n    msg.topic = msg.topic + \"_extracted\";\n    \n    msg.payload = await rows.reduce((all, one) =>{\n        \n        if(!Array.isArray(all)){\n            all = [];\n        }\n        \n        result = all[one.event_number];\n        \n        console.log(result);\n        \n        if (result === undefined) {\n            // not found\n            one.all = [];\n            all.splice(one.event_number, 0, one);\n        }  else {\n            // multiple items found\n            result.all.splice(one.event_number, 0, one);\n        }\n        \n        return all;\n    });\n    \n    node.send(msg);\n    //console.log(rows.join('\\n'));\n    //console.log(rows);\n  \n    browser.close();\n})();","outputs":1,"noerr":0,"x":370,"y":560,"wires":[[]]},{"id":"87f930de.d8c47","type":"html","z":"53ede10e.62c14","name":"","property":"payload.innerHTML","tag":"","ret":"html","as":"multi","x":790,"y":160,"wires":[["7457705d.707da"]]},{"id":"7457705d.707da","type":"debug","z":"53ede10e.62c14","name":"","active":true,"tosidebar":true,"console":true,"tostatus":false,"complete":"payload","x":960,"y":160,"wires":[]},{"id":"1dd64fcd.2bcbb","type":"function","z":"53ede10e.62c14","name":"","func":"//Extract\n        function map_document(doc, models){\n        \n            return models.map(model=> {\n                \n                model.rows = [];\n                \n                anchors = Array.from(doc.querySelectorAll(model.selector));\n                    \n                anchors.forEach((anchor) => {\n                    row = {};\n                    row.messages = [];\n                    \n                    row.key = model.key;\n                    row.selector = model.selector;\n                    \n                    row.attributes = Array.from(anchor.attributes).map(someAt => ({name: someAt.name, value: someAt.value}))\n                    row.attributes.push({name: \"textContent\", value: `${anchor.textContent}`});\n                    row.attributes.push({name: \"innerHTML\", value: `${anchor.innerHTML}`});\n                    row.attributes.push({name: \"outerHTML\", value: `${anchor.outerHTML}`});\n                    row.value = null;\n                    \n                    if(model.hasOwnProperty(\"value\")){\n                        row.messages.push(\"model \" + model.key + \" has value\");\n                        row.attribute = row.attributes.find(o => o.name === model.value);\n                        if(row.attribute!==undefined) row.value = row.attribute.value;\n                    }\n                    \n                    if(model.hasOwnProperty(\"models\")){\n                        row.messages.push(\"model \" + model.key + \" has models\");\n                        map_document(anchor, model.models);\n                    }\n                    \n                    if(model.hasOwnProperty(\"fields\")){\n                        row.messages.push(\"model \" + model.key + \" has fields\");\n                        map_document(anchor, model.fields);\n                    }\n                    \n                    model.rows.push(row);\n                });\n                \n                return model;\n                \n            });\n        }\n\n        return map_document(document, models);\n        /*return maps.map(map=> {\n            \n            if(map.anchor===undefined) map.anchor = document;\n            \n            anchors = Array.from(map.anchor.querySelectorAll(map.selector));\n            \n            return anchors.map((anchor, index, array) => {\n                row = {};\n                \n                row.textContent = `${anchor.textContent}`;\n                row.innerHTML = `${anchor.innerHTML}`;\n                //row.outerHTML = `${anchor.outerHTML}`;\n                row.innerJson = `${anchor.innerHTML}`;\n                \n                if(map.hasOwnProperty(\"selectors\")){\n                    \n                }\n                \n                return row;\n            });\n            \n        });*/\n        \nreturn msg;","outputs":1,"noerr":0,"x":180,"y":640,"wires":[[]]},{"id":"2cfee123.0f07ee","type":"function","z":"25e0c6e7.7b804a","name":"query Selectors","func":"'use strict';\n\nmsg.topic = \"1betpro\";\n\n//For Debuging with injection and without kafka\nif(msg.payload.value!==undefined){\n    msg.payload = msg.payload.value;\n}\nelse{\n    msg.payload.value = msg.payload;\n}\n//End Debugging\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    result = await page.evaluate(queries => {\n        \n        var attributes = function (e){\n            \n            result = Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n            result.push({name: 'innerText', value: e.innerText});\n            result.push({name: 'innerHTML', value: e.innerHTML});\n            result.push({name: 'outerHTML', value: e.outerHTML});\n            \n            return result;\n        }\n        \n        var groupBy = function(xs, key) {\n            return xs.reduce(function(rv, x) {\n                (rv[x[key]] = rv[x[key]] || []).push(x);\n                return rv;\n            }, {});\n        };\n            \n        var select = function(e) {\n            \n            if(e.document===undefined) e.document = document;\n            \n            e.queries.filter(query => query.enabled).map(query => {\n        \n                query.result =[];\n                \n                try{\n                    \n                    if(query.selector!==undefined){\n                        \n                        query.selected = true;\n                        query.result = Array.from(e.document.querySelectorAll(query.selector));\n\n                        if(query.pageFunction!==undefined){\n                            query.mapped = true;\n                            query.result.map(eval(query.pageFunction));\n                        }\n                        \n                    }\n                    \n                    if((query.queries!==undefined || e.key!==undefined ) && query.result.length>0){\n                        \n                        /*query.result.map(row => {\n                            \n                            row.data = row;\n                            row.queries = query.queries;\n                            row.parent = (e.key!==undefined) ? e.key : null;\n                            if(query.queries!==undefined && query.result.length>0) select(row);\n                            \n                            return row;\n                        });*/\n                    }\n                }\n                catch(error){\n                    console.error(error);\n                    query.error = error.message;\n                }\n                \n                return query;\n            })\n            \n            return e;\n        }\n        \n        let e = {queries: queries};\n        \n        return select(e);\n        \n    },msg.payload.value.queries);\n    \n    \n    //Array.from(e.attributes).map(attribute => ({name: attribute.name, value: attribute.value}))\n    msg.payload = result;\n    /*msg.payload = await page.evaluate({\n        return Array.from(document.querySelectorAll(results_selector));\n    });*/\n    \n    msg.topic = msg.topic + \"_extracted\";\n\n    node.send(msg);\n    \n        \n    \n\n    await browser.close();\n\n})();","outputs":1,"noerr":0,"x":460,"y":220,"wires":[["6d93887e.c57a98"]]},{"id":"c0161a6e.61b848","type":"function","z":"25e0c6e7.7b804a","name":"prepare 1betpro message","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage'],\n        url: 'https://home.nest.com/camera/ae89b93cd81b433d878c7bc4c38eb606',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : '.live_lines',//'tr.bets_lines td',\n        queries:[{\n                selector: \".live_lines\",\n                //name: \"live_lines\",\n                pageFunction : \"e => ({ document: e, key: 'live_lines'})\",\n                args: [],\n                enabled: true,\n                queries:[{\n                    selector: \".live_lines div[league_id]\",\n                    //name: \"leagues\",\n                    pageFunction : \"e => ({document: e, type: 'league', key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                    args: [],\n                    enabled: true,\n                    queries:[{\n                        selector: \".teams\",\n                        //name: \"teams\",\n                        pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, index :index})\",\n                        //filter: \"line => line.index % 3 === 0\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true            \n                    },{\n                        selector: \".bets_lines\",\n                        //name: \"lines\",\n                        pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, index :index})\",\n                        //groupBy: 'number',\n                        args: [],\n                        enabled: true\n                    }]\n                }],\n            },{\n                selector: \".live_lines div[league_id]\",\n                pageFunction : \"e => ({type: 'league', innerHTML: e.innerHTML, key: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value})\",\n                args: [],\n                enabled: false,\n                queries:[{\n                    selector: \".teams\",\n                    pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: e.parent.key, index :index})\",\n                    //filter: \"line => line.index % 3 === 0\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false            \n                },{\n                    selector: \".bets_lines\",\n                    pageFunction : \"(e ,index) => ({type :'line.bet', number: Math.floor(index / 3), row: e.innerText, league_id: e.parent, index :index})\",\n                    groupBy: 'number',\n                    args: [],\n                    enabled: false\n                }]\n            },{\n                selector: \".live_lines > table .head_line_bottom b\",\n                pageFunction : \"e => ({type: 'league', name: e.innerText})\",\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .bets_lines\",\n                pageFunction : \"(e ,index) => ({type :'line', row: e.innerText.split('\\\\t')[0], index :index})\",\n                groupBy: 'number',\n                args: [],\n                enabled: false\n            },{\n                selector: \".live_lines > div[league_id] .teams\",\n                pageFunction : \"(e ,index) => ({type :'line.team', number: Math.floor(index / 3), team: e.innerText, league_id: attributes(e).filter(attribute => attribute.name === 'league_id')[0].value,index :index})\",\n                //filter: \"line => line.index % 3 === 0\",\n                groupBy: 'number',\n                args: [],\n                enabled: false            \n            }],\n        models: \n            [{\n                key : \"LiveLine\",\n                selector: \".live_lines\",\n                value: \"outerHTML\",\n                models: [{\n                    key : \"League\",\n                    selector : \"div[league_id]\",\n                    value: \"league_id\",\n                    fields: [{\n                        key : \"name\",\n                        selector : \".head_line_bottom b\",\n                        value: \"textContent\"\n                    }]\n                }]\n            }],\n        reduce_selector : '.head_line_bottom b',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":680,"wires":[[]]},{"id":"3bffe9c0.a0e006","type":"http request","z":"5e038606.189078","name":"","method":"use","ret":"txt","url":"","tls":"363f279c.1671a8","x":970,"y":160,"wires":[["64072e04.06735"]]},{"id":"1aaf84ff.448a0b","type":"function","z":"5e038606.189078","name":"List Clips","func":"msg.headers = {\n        'Cookie': '_ga=GA1.2.1758159844.1516371953; eu_cookie_accepted=1; n=eyJoYXMiOnsiNzUwMTUwNSI6eyJzdHIiOjF9fSwiaWRzIjpbIjc1MDE1MDUiXX0%3D; eu_compliance=3; viewer-volume=0.97; cztoken=b.7501505.rqaTHJgH5M87Fp0qHEOpBZdem7HAaIHQ5e1stKHzR9stSw4JWGGmKRqnl7ZMoRsHZNnnoqgFZrsgEPzXB2eCkGFHIk9KG2klb6OPTsMcapkINrrFx8D34ssQkdSozVI4WS5g4fiMpxIXlyNZ; website_2=31b2b621f1da4da9bf12e0ce0bf04a96e33dfac5bfad5c4b4f2bee357b5819c0055d097e; _gid=GA1.2.427877016.1520594974; _gat_UA-19609914-2=1',\n        //'Accept-Encoding' : 'gzip, deflate, br',\n        'Accept-Language': \"en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36\",\n        'Accept': 'application/json, text/javascript, */*; q=0.01',\n        'Referer': 'https://home.nest.com/',\n        'X-Requested-With': 'XMLHttpRequest' ,\n        'Connection': 'keep-alive'\n    };\n    \nmsg.url = 'https://home.nest.com/dropcam/api/visible_clips?_=' + msg.timestamp;\nmsg.method = 'GET';\n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":160,"wires":[["3bffe9c0.a0e006"]]},{"id":"d7f5e1a5.24283","type":"debug","z":"5e038606.189078","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1750,"y":400,"wires":[]},{"id":"64072e04.06735","type":"json","z":"5e038606.189078","name":"","property":"payload","action":"","pretty":false,"x":1130,"y":160,"wires":[["241de08f.638c7"]]},{"id":"241de08f.638c7","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload[0].clips","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":220,"wires":[["92e70c37.1cf6a","283c192e.96aa36"]]},{"id":"283c192e.96aa36","type":"split","z":"5e038606.189078","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1450,"y":280,"wires":[["1d138d23.bad103"]]},{"id":"db94937f.1ba2d","type":"youtube-upload","z":"5e038606.189078","google":"8f853068.0d7cf","name":"","title":"payload.title","titleType":"msg","description":"payload.description","descriptionType":"msg","privacyStatus":"private","mediapath":"mediapath","mediapathType":"msg","x":1500,"y":400,"wires":[["d7f5e1a5.24283"]]},{"id":"61428a7a.dd0224","type":"http in","z":"5e038606.189078","name":"","url":"google-credentials-youtube/auth/callback","method":"get","upload":false,"swaggerDoc":"","x":510,"y":620,"wires":[["980eba9e.9c6188"]]},{"id":"980eba9e.9c6188","type":"http response","z":"5e038606.189078","name":"","statusCode":"","headers":{},"x":900,"y":620,"wires":[]},{"id":"ae71e6c9.b15598","type":"http request","z":"5e038606.189078","name":"","method":"GET","ret":"bin","url":"","tls":"","x":1990,"y":240,"wires":[["d87c638b.9ca78"]]},{"id":"42456c3d.4c7ee4","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"url","pt":"msg","to":"payload.download_url","tot":"msg"},{"t":"set","p":"filename","pt":"msg","to":"$join([\"/data/cameras/\" ,$string(msg.payload.camera_uuid), \"/clips/\" ,$string(msg.payload.filename)], \"\")","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":240,"wires":[["ae71e6c9.b15598"]]},{"id":"d87c638b.9ca78","type":"file","z":"5e038606.189078","name":"Video","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"true","x":2190,"y":240,"wires":[]},{"id":"181e8f45.7a5621","type":"file","z":"5e038606.189078","name":"Clip","filename":"","appendNewline":true,"createDir":true,"overwriteFile":"true","x":2190,"y":320,"wires":[]},{"id":"8cae5d7e.d5284","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"filename","pt":"msg","to":"$join([\"/data/cameras/\" ,$string(msg.payload.camera_uuid), \"/clips/\" ,$string(msg.payload.filename), \".info\"], \"\")","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1790,"y":320,"wires":[["181e8f45.7a5621"]]},{"id":"f16a76ee.e54928","type":"watch","z":"5e038606.189078","name":"Cameras","files":"/data/cameras","recursive":true,"x":130,"y":400,"wires":[["918dca80.cf5f28"]]},{"id":"918dca80.cf5f28","type":"split","z":"5e038606.189078","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":300,"y":400,"wires":[["576d357c.37831c"]]},{"id":"576d357c.37831c","type":"switch","z":"5e038606.189078","name":"match","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"^.*\\.(mp4)$","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":460,"y":400,"wires":[["b4e714f9.f755f8"]]},{"id":"6e279121.1996f","type":"file in","z":"5e038606.189078","name":"Info","filename":"","format":"utf8","chunk":false,"sendError":false,"x":820,"y":400,"wires":[["77d10325.217a0c"]]},{"id":"b4e714f9.f755f8","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"filename","pt":"msg","to":"$join([$string(msg.payload), \".info\"], \"\")","tot":"jsonata"},{"t":"set","p":"mediapath","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":400,"wires":[["6e279121.1996f"]]},{"id":"77d10325.217a0c","type":"json","z":"5e038606.189078","name":"","property":"payload","action":"","pretty":false,"x":960,"y":400,"wires":[["9999efc6.93ed1"]]},{"id":"9999efc6.93ed1","type":"switch","z":"5e038606.189078","name":"","property":"payload.title","propertyType":"msg","rules":[{"t":"neq","v":"\"\"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1150,"y":400,"wires":[["db94937f.1ba2d","2118c2b6.c133fe"]]},{"id":"57e02e68.34a8e","type":"inject","z":"5e038606.189078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":410,"y":720,"wires":[["cf17b177.ea423"]]},{"id":"d35c5b3e.a8b738","type":"debug","z":"5e038606.189078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":880,"y":720,"wires":[]},{"id":"110664b3.d7891b","type":"inject","z":"5e038606.189078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":160,"wires":[["e6a09ac1.e64b78"]]},{"id":"94fe85f2.91a338","type":"function","z":"5e038606.189078","name":"Create Clip","func":"msg.headers = {\n        'Cookie': '_ga=GA1.2.1758159844.1516371953; eu_cookie_accepted=1; n=eyJoYXMiOnsiNzUwMTUwNSI6eyJzdHIiOjF9fSwiaWRzIjpbIjc1MDE1MDUiXX0%3D; eu_compliance=3; viewer-volume=0.97; cztoken=b.7501505.rqaTHJgH5M87Fp0qHEOpBZdem7HAaIHQ5e1stKHzR9stSw4JWGGmKRqnl7ZMoRsHZNnnoqgFZrsgEPzXB2eCkGFHIk9KG2klb6OPTsMcapkINrrFx8D34ssQkdSozVI4WS5g4fiMpxIXlyNZ; website_2=31b2b621f1da4da9bf12e0ce0bf04a96e33dfac5bfad5c4b4f2bee357b5819c0055d097e; _gid=GA1.2.427877016.1520594974; _gat_UA-19609914-2=1',\n        //'Accept-Encoding' : 'gzip, deflate, br',\n        'Accept-Language': \"en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36\",\n        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',\n        'Referer': 'https://home.nest.com/',\n        'X-Requested-With': 'XMLHttpRequest' ,\n        'Connection': 'keep-alive',\n        'Accept': '*/*'\n    };\n\nmsg.url = 'https://webapi.camera.home.nest.com/api/clips.request';\nmsg.method = 'POST';\nmsg.payload = {\n        'uuid': msg.request.uuid,\n        'title': msg.request.where + \"_\" + (msg.timestamp - (msg.timestamp % 3600)),\n        'start_date': msg.timestamp - (msg.timestamp % 3600),\n        'is_public':false,\n        'length': msg.request.interval,\n        'target_length': false\n};\n\nfunction serialize( obj ) {\n  return Object.keys(obj).reduce(function(a,k){a.push(k+'='+encodeURIComponent(obj[k]));return a},[]).join('&')\n}\n\n//msg.payload = 'uuid=ae89b93cd81b433d878c7bc4c38eb606&title=KidsRoomTest&start_date=1520175600.000&is_public=false&length=3600&target_length=false';\n\nmsg.payload = serialize(msg.payload);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1790,"y":140,"wires":[["1d710e0a.6654d2"]]},{"id":"92e70c37.1cf6a","type":"function","z":"5e038606.189078","name":"Clip exists?","func":"msg.topic = (msg.payload.filter( clip => {\n    clip.start_time===(msg.timestamp - (msg.timestamp % msg.request.interval)) && clip.camera.uuid === msg.request.uuid\n}).length===0) ? \"CREATE_CLIP\" : \"CLIP_EXISTS\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1470,"y":100,"wires":[["6ae25ca7.54fb44"]]},{"id":"1d138d23.bad103","type":"switch","z":"5e038606.189078","name":"","property":"payload.length_in_seconds","propertyType":"msg","rules":[{"t":"gt","v":"3550","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1610,"y":280,"wires":[["42456c3d.4c7ee4","8cae5d7e.d5284"]]},{"id":"6ae25ca7.54fb44","type":"switch","z":"5e038606.189078","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"CLIP_EXISTS","vt":"str"},{"t":"eq","v":"CREATE_CLIP","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1630,"y":100,"wires":[["fd460d53.b2271"],["94fe85f2.91a338"]]},{"id":"fd460d53.b2271","type":"debug","z":"5e038606.189078","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1790,"y":60,"wires":[]},{"id":"f24ccde6.c456c","type":"debug","z":"5e038606.189078","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":2190,"y":140,"wires":[]},{"id":"269b785.400b188","type":"http request","z":"5e038606.189078","name":"","method":"use","ret":"txt","url":"","tls":"363f279c.1671a8","x":1990,"y":140,"wires":[["f24ccde6.c456c"]]},{"id":"e6a09ac1.e64b78","type":"function","z":"5e038606.189078","name":"Set variables","func":"function roundMinutes(date) {\n\n    date.setHours((date.getHours() + 2));\n    date.setMinutes(0);\n    date.setSeconds(0);\n    date.setMilliseconds(0);\n    \n    return date;\n}\n\nmsg.timestamp = msg.payload;\nmsg.rounded_timestamp = roundMinutes(new Date(msg.timestamp)).toISOString().replace(\"T\",\" \").replace(\".000Z\",\"\");\n\nmsg.payload = [{\n        uuid : 'ae89b93cd81b433d878c7bc4c38eb606',\n        where : \"Itai's Room\"\n    },{\n        uuid: '436169d9795b4b9c996f42f077993992',\n        where: 'Living Room'\n    }];\n\nmsg.payload.map(camera => {\n    camera.clip_title = camera.where.replace(\" \",\"\") + \" \" + msg.rounded_timestamp;//new Date(msg.rounded_timestamp + camera.timezone * 60000).toISOString().replace(\"T\",\" \").replace(\".000Z\",\"\")\n })\n \nreturn msg;","outputs":1,"noerr":0,"x":290,"y":160,"wires":[["8fb1ffa3.df90f"]]},{"id":"8fb1ffa3.df90f","type":"split","z":"5e038606.189078","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":450,"y":160,"wires":[["1ed8247b.45570c"]]},{"id":"1d710e0a.6654d2","type":"debug","z":"5e038606.189078","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1990,"y":60,"wires":[]},{"id":"2118c2b6.c133fe","type":"debug","z":"5e038606.189078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1470,"y":500,"wires":[]},{"id":"cf17b177.ea423","type":"YouTube PlayLists","z":"5e038606.189078","config":"c21e0590.e618e8","part":"snippet","channelId":"","playlistId":"","mine":"true","maxResults":5,"onBehalfOfContentOwner":"","onBehalfOfContentOwnerChannel":"","pageToken":"","name":"","x":630,"y":720,"wires":[["d35c5b3e.a8b738"]]},{"id":"4e34f9a0.a41798","type":"google","z":"5e038606.189078","name":"YouTube Search","google":"fc09f44f.92f2b8","api":"youtube:v3","operation":"search.list","x":1010,"y":280,"wires":[["dfec82.dff3338"]]},{"id":"cb018197.67a78","type":"inject","z":"5e038606.189078","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":500,"wires":[[]]},{"id":"dfec82.dff3338","type":"debug","z":"5e038606.189078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1230,"y":280,"wires":[]},{"id":"1ed8247b.45570c","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"nest","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"youtube.maxResults","pt":"msg","to":"1","tot":"str"},{"t":"set","p":"youtube.part","pt":"msg","to":"snippet","tot":"str"},{"t":"set","p":"youtube.type","pt":"msg","to":"video","tot":"str"},{"t":"set","p":"youtube.forMine","pt":"msg","to":"true","tot":"bool"},{"t":"set","p":"youtube.q","pt":"msg","to":"payload.clip_title","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":160,"wires":[["1aaf84ff.448a0b","64c3292.bfa15d8"]]},{"id":"9e5805ce.3e1638","type":"comment","z":"5e038606.189078","name":"Get List of Available Nest Clips","info":"","x":970,"y":100,"wires":[]},{"id":"caf899c2.1f4068","type":"comment","z":"5e038606.189078","name":"Check if need to create a new hourly clip","info":"","x":1460,"y":40,"wires":[]},{"id":"d8c11876.131818","type":"comment","z":"5e038606.189078","name":"Need to create clip","info":"","x":1610,"y":160,"wires":[]},{"id":"64c3292.bfa15d8","type":"change","z":"5e038606.189078","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"youtube","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":280,"wires":[["4e34f9a0.a41798"]]},{"id":"15bcdf44.f860b1","type":"inject","z":"8743a80b.8df4a8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":160,"wires":[["4da3e6c.6bf0318"]]},{"id":"d41b6ad5.53c4a8","type":"function","z":"8743a80b.8df4a8","name":"Get Data","func":"'use strict';\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    \n    try{\n        const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox', '--shm-size=1gb', '--disable-dev-shm-usage']});\n        const page = await browser.newPage();\n    \n        console.log('Go to 1BetPro Website');\n        await page.goto('https://1betpro.com/');\n\n        console.log('Type the login information :' + JSON.stringify(msg.payload));\n        await page.type('#form > div:nth-child(2) > input', msg.payload.username);\n        await page.type('#form > div:nth-child(3) > input', msg.payload.password);\n\n        await page.waitForSelector('#form > input');\n\n        console.log('Login')\n        await page.click('#form > input');\n        \n        console.log('Wait till logged in')\n        await page.waitForSelector('#logout_user');\n        \n        console.log('Logged In, saving cookies')\n        let cookies = await  page.cookies()\n        \n        msg.Cookie = await cookies.reduce(function(prevVal,currVal,idx){\n            return idx == 0 ? currVal.name + \"=\" + currVal.value : prevVal + '; ' + currVal.name + \"=\" + currVal.value;\n        }, '');\n        \n        //msg.Cookie = await cookies.reduce((accumulator, currentValue) => accumulator + currentValue.name + \"=\" + currentValue.value + \"; \");\n\n        console.log('Go to live bets')\n        await page.goto('https://1betpro.com/live/');\n        \n        const allBetsSelector = '.bets_lines .addbetslip';\n        const changedBetsSelector = '.bets_lines .addbetslip.changed';\n\n        console.log('Wait for the results page to load and display the results.')\n        await page.waitForSelector(allBetsSelector);\n    \n        var iterator = new Array(2);\n        \n        await iterator.forEach(i => {\n            \n            resultsSelector = changedBetsSelector;\n            \n            if(i===0){\n                resultsSelector = allBetsSelector;\n            }\n            \n            console.log('Extract the results from the page.')\n            msg.payload = page.evaluate(resultsSelector => {\n                \n                const anchors = Array.from(document.querySelectorAll(resultsSelector));\n        \n                return anchors.map(anchor => {\n                    \n                    bet = {\n                        mode : 'betslip',\n                        action: 'add',\n                        id: `${anchor.id}`,\n                        desc: anchor.innerHTML,\n                        human: 1,\n                        rnd: Date.now()-(1000 * 5),\n                        delta_time: 5000\n                    }\n                    \n                    return bet;\n                    \n                });\n                \n            }, resultsSelector);\n            \n            msg.topic = \"SUCCESS\";\n            \n            node.send(msg);\n            \n            sleep(5000);\n            \n        });\n        \n        await browser.close();\n    }\n    catch(e){\n        node.error(e);\n        \n        msg.topic = \"FAILED\";\n        \n        node.send(msg);\n        \n        //await browser.close();\n    }\n})();","outputs":1,"noerr":0,"x":520,"y":160,"wires":[["f873fad9.41a428"]]},{"id":"4da3e6c.6bf0318","type":"change","z":"8743a80b.8df4a8","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"username\":\"Tal1234\",\"password\":\"1111\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":160,"wires":[["d41b6ad5.53c4a8"]]},{"id":"3c05d581.65dd1a","type":"debug","z":"8743a80b.8df4a8","name":"Success","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2480,"y":120,"wires":[]},{"id":"f873fad9.41a428","type":"switch","z":"8743a80b.8df4a8","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"SUCCESS","vt":"str"},{"t":"eq","v":"FAILED","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":160,"wires":[["65eefc9a.650b94"],["f00d4178.a00ec"]]},{"id":"f00d4178.a00ec","type":"debug","z":"8743a80b.8df4a8","name":"Failed","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":890,"y":200,"wires":[]},{"id":"a9e4f036.900c3","type":"function","z":"8743a80b.8df4a8","name":"Get Bet Data","func":"msg.headers = {\n        'Cookie': msg.Cookie,//'__cfduid=da00ff682e48869bb07731ce13450d93a1517830510; PHPSESSID=prhrgubveoluc4u1ucqd7nqq46; sscd=5972a0918decbaca55c13f40a5836e38; lng=en; odds=a; type=bets; _ym=145236; uicd=1f0805a7df8a1dee54f1f11ae5aa9543',\n        //'Accept-Encoding' : 'gzip, deflate, br',\n        'Accept-Language': \"en-US,en;q=0.9,es;q=0.8,sq;q=0.7,he;q=0.6' -H 'User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.132 Safari/537.36\",\n        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',\n        'Referer': 'https://1betpro.com/live/',\n        'X-Requested-With': 'XMLHttpRequest' ,\n        'Connection': 'keep-alive',\n        'Accept': '*/*',\n        'Origin': 'https://1betpro.com',\n        'authority': '1betpro.com'\n    };\n\nmsg.url = 'https://1betpro.com/ajax/';\nmsg.method = 'POST';\n\nfunction serialize( obj ) {\n  return Object.keys(obj).reduce(function(a,k){a.push(k+'='+encodeURIComponent(obj[k]));return a},[]).join('&')\n}\n\nmsg.payload = serialize(msg.payload);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1230,"y":120,"wires":[["26c56af.7ba7d96"]]},{"id":"26c56af.7ba7d96","type":"http request","z":"8743a80b.8df4a8","name":"","method":"use","ret":"txt","url":"","tls":"363f279c.1671a8","x":1410,"y":120,"wires":[["65b4b16.196bc5"]]},{"id":"65eefc9a.650b94","type":"split","z":"8743a80b.8df4a8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":890,"y":120,"wires":[["7b56cae8.aa0ce4"]]},{"id":"65b4b16.196bc5","type":"json","z":"8743a80b.8df4a8","name":"","property":"payload","action":"","pretty":false,"x":1570,"y":120,"wires":[["2a588b42.a2bae4"]]},{"id":"7b56cae8.aa0ce4","type":"delay","z":"8743a80b.8df4a8","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1050,"y":120,"wires":[["a9e4f036.900c3"]]},{"id":"f02b5075.90eb2","type":"create","z":"8743a80b.8df4a8","name":"onebetpro","documentIndex":"","documentType":"","server":"43749542.37d54c","x":2310,"y":120,"wires":[["3c05d581.65dd1a"]]},{"id":"2a588b42.a2bae4","type":"change","z":"8743a80b.8df4a8","name":"","rules":[{"t":"set","p":"documentIndex","pt":"msg","to":"onebetpro-betslip","tot":"str"},{"t":"set","p":"documentType","pt":"msg","to":"doc","tot":"str"},{"t":"set","p":"documentId","pt":"msg","to":"","tot":"date"},{"t":"set","p":"payload","pt":"msg","to":"payload.betslip.bets","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":120,"wires":[["550143d3.d74fcc"]]},{"id":"550143d3.d74fcc","type":"split","z":"8743a80b.8df4a8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1910,"y":120,"wires":[["7bff18a.fd6cbe8"]]},{"id":"7bff18a.fd6cbe8","type":"change","z":"8743a80b.8df4a8","name":"","rules":[{"t":"set","p":"payload.timestamp","pt":"msg","to":"","tot":"date"}],"action":"","property":"","from":"","to":"","reg":false,"x":2100,"y":120,"wires":[["f02b5075.90eb2"]]}]