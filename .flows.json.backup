[{"id":"25e0c6e7.7b804a","type":"tab","label":"Puppet Show","disabled":false,"info":""},{"id":"5aa43ca5.797fa4","type":"tab","label":"Paste Bin","disabled":true,"info":""},{"id":"151d107c.6f1aa","type":"debug","z":"25e0c6e7.7b804a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":930,"y":280,"wires":[]},{"id":"20d8b05a.fe4ba","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":210,"y":160,"wires":[["15533bd8.282f44"]]},{"id":"15533bd8.282f44","type":"function","z":"25e0c6e7.7b804a","name":"query Selectors","func":"'use strict';\nmsg.topic = \"1betpro\";\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    // Extract the results from the page.\n    rows = await page.evaluate(results_selector => {\n        \n        //Extract\n        anchors = Array.from(document.querySelectorAll(results_selector));\n        \n        \n        //Transform\n        return anchors.map((anchor, index, array) => {\n            row = {};\n                \n            row.fixed_number_of_total_td_in_tr = 10;\n            row.array_length = array.length;\n            \n            row.index = index;\n            row.event_number = Math.floor(row.index/10);\n            row.textContent = `${anchor.textContent}`;\n            row.innerHTML = `${anchor.innerHTML}`;\n            \n            if(`${anchor.id}`!==\"\"){\n                row.id = `${anchor.id}`;\n                \n                row.team_anchor_index = (row.event_number*10);\n                \n                //team_anchor = array[team_anchor_index];\n                \n                //console.log(team_anchor);\n                \n                //row.team_innerHTML = `${team_anchor.innerHTML}`;\n                \n                row.source = anchor;\n                \n                row.elements = row.innerHTML.split(\"</\");\n                //custom transformation\n                row.id_parts = row.id.split(\"_\");\n                row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n                row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n                row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n                row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n                row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n                \n                //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n                //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n                  \n                row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n                \n                row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n                row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n                \n                row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n        \n                row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n        \n                //console.log(row);\n            //}\n            //catch(e){\n                \n            //}\n            }\n            \n            return row;\n            \n        });\n    }, msg.payload.value.results_selector);\n  \n    msg.topic = msg.topic + \"_extracted\";\n    \n    msg.payload = await rows.reduce((all, one) =>{\n        \n        result = all[one.event_number];\n        \n        if (result === undefined) {\n            // not found\n            one.all = [];\n            all.push(one);\n        }  else {\n            // multiple items found\n            result[0].all.push(one);\n        }\n        \n        return all;\n    });\n    \n    await node.send(msg);\n    //console.log(rows.join('\\n'));\n    //console.log(rows);\n  \n    await browser.close();\n})();","outputs":1,"noerr":0,"x":360,"y":160,"wires":[["6d93887e.c57a98"]]},{"id":"c828717a.8ab8","type":"function","z":"5aa43ca5.797fa4","name":"","func":"global.toJSON = function toJSON(node) {\n  node = node || this;\n  var obj = {\n    nodeType: node.nodeType\n  };\n  if (node.tagName) {\n    obj.tagName = node.tagName.toLowerCase();\n  } else\n  if (node.nodeName) {\n    obj.nodeName = node.nodeName;\n  }\n  if (node.nodeValue) {\n    obj.nodeValue = node.nodeValue;\n  }\n  var attrs = node.attributes;\n  if (attrs) {\n    var length = attrs.length;\n    var arr = obj.attributes = new Array(length);\n    for (var i = 0; i < length; i++) {\n      attr = attrs[i];\n      arr[i] = [attr.nodeName, attr.nodeValue];\n    }\n  }\n  var childNodes = node.childNodes;\n  if (childNodes) {\n    length = childNodes.length;\n    arr = obj.childNodes = new Array(length);\n    for (i = 0; i < length; i++) {\n      arr[i] = toJSON(childNodes[i]);\n    }\n  }\n  return obj;\n};\n\nglobal.toDOM = function toDOM(obj) {\n  if (typeof obj == 'string') {\n    obj = JSON.parse(obj);\n  }\n  var node, nodeType = obj.nodeType;\n  switch (nodeType) {\n    case 1: //ELEMENT_NODE\n      node = document.createElement(obj.tagName);\n      var attributes = obj.attributes || [];\n      for (var i = 0, len = attributes.length; i < len; i++) {\n        var attr = attributes[i];\n        node.setAttribute(attr[0], attr[1]);\n      }\n      break;\n    case 3: //TEXT_NODE\n      node = document.createTextNode(obj.nodeValue);\n      break;\n    case 8: //COMMENT_NODE\n      node = document.createComment(obj.nodeValue);\n      break;\n    case 9: //DOCUMENT_NODE\n      node = document.implementation.createDocument();\n      break;\n    case 10: //DOCUMENT_TYPE_NODE\n      node = document.implementation.createDocumentType(obj.nodeName);\n      break;\n    case 11: //DOCUMENT_FRAGMENT_NODE\n      node = document.createDocumentFragment();\n      break;\n    default:\n      return node;\n  }\n  if (nodeType == 1 || nodeType == 11) {\n    var childNodes = obj.childNodes || [];\n    for (i = 0, len = childNodes.length; i < len; i++) {\n      node.appendChild(toDOM(childNodes[i]));\n    }\n  }\n  return node;\n};\n","outputs":1,"noerr":0,"x":270,"y":120,"wires":[[]]},{"id":"fcf73cfd.bae76","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":160,"wires":[["20d8b05a.fe4ba"]]},{"id":"7ac484b7.34c5fc","type":"kafka producer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":890,"y":160,"wires":[]},{"id":"ec67ce57.5fe5b","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":120,"y":280,"wires":[["2eb771d3.abcbee"]]},{"id":"2eb771d3.abcbee","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":490,"y":280,"wires":[["151d107c.6f1aa"]]},{"id":"8e8ed84d.848508","type":"inject","z":"25e0c6e7.7b804a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":80,"wires":[["a0fbec9e.347ae"]]},{"id":"a0fbec9e.347ae","type":"function","z":"25e0c6e7.7b804a","name":"prepare 1betpro message","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox'],\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : 'tr.bets_lines td',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\n//msg.payload = JSON.stringify(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[["c0854aa1.d7d978"]]},{"id":"c0854aa1.d7d978","type":"kafka producer","z":"25e0c6e7.7b804a","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":920,"y":80,"wires":[]},{"id":"6d93887e.c57a98","type":"switch","z":"25e0c6e7.7b804a","name":"1betpro","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1betpro_extracted","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":540,"y":160,"wires":[["151d107c.6f1aa"]]},{"id":"4bcd4375.8f581c","type":"function","z":"25e0c6e7.7b804a","name":"Aggregate","func":"const fixed_number_of_total_td_in_tr = 10;\nconst start_from_td = 2;\nanchors = msg.payload;\n\naggregated_rows = [];\n\nfor (i = start_from_td; i < anchors.length; i+fixed_number_of_total_td_in_tr) {\n    \n    try{\n        const anchor = anchors[i];\n        \n        row = {};\n        \n        row.team  = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[1].split(\">\")[anchor.innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n        row.score = (anchor.innerHTML.lenght>0) ? anchor.innerHTML.split(\"</\")[0].split(\">\")[anchor.innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n          \n        aggregated_rows.push(row); \n    }\n    catch(e){\n        \n    }\n}\n\nmsg = {\n    topic: \"1betpro_aggregated\",\n    payload : aggregated_rows\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":120,"wires":[["151d107c.6f1aa"]]}]