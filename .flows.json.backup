[{"id":"75754e68.a55af","type":"tab","label":"Producers","disabled":true,"info":""},{"id":"25e0c6e7.7b804a","type":"tab","label":"Consumers","disabled":false,"info":""},{"id":"5aa43ca5.797fa4","type":"tab","label":"Paste Bin","disabled":true,"info":""},{"id":"f2ff6f77.dd264","type":"tab","label":"Chrome Puppeteer test","disabled":false,"info":""},{"id":"3153b58.481094a","type":"remote-server","z":"","name":"elasticsearch","host":"http://elasticsearch","port":"9200"},{"id":"c1d2aad5.c62ec8","type":"mongodb3","z":"","uri":"mongodb://mongodb-replicaset-mongodb-replicaset-0.mongodb-replicaset-mongodb-replicaset,mongodb-replicaset-mongodb-replicaset-1.mongodb-replicaset-mongodb-replicaset,mongodb-replicaset-mongodb-replicaset-2.mongodb-replicaset-mongodb-replicaset:27017/datagram","name":"mongodb","options":"","parallelism":"-1"},{"id":"ef31721b.a1642","type":"mongodb2","z":"","uri":"mongodb://mongodb-replicaset-mongodb-replicaset-0.mongodb-replicaset-mongodb-replicaset.default.svc.cluster.local:27017/datagram?replicaSet=rs0","name":"","options":"","parallelism":"-1"},{"id":"55a2f72f.71acd8","type":"kafka-broker","z":"","broker":"10.56.1.157:9092,10.56.1.158:9092","clientid":""},{"id":"baf2a4f6.c29108","type":"kafka-broker","z":"","broker":"zookeeper-zookeeper-0:2181,zookeeper-zookeeper-1:2181","clientid":""},{"id":"f49fd7e1.d07888","type":"kafka-broker","z":"","broker":"kafka-kafka-headless:9092","clientid":""},{"id":"2c2b843b.32f3fc","type":"kafka-broker","z":"","broker":"10.56.0.211:2181,10.56.1.154:2181","clientid":""},{"id":"85e43cb.44af3c","type":"kafka-broker","z":"","broker":"kafka-kafka.default.svc.cluster.local:9092","clientid":""},{"id":"c6084928.798678","type":"kafka-broker","z":"","broker":"zookeeper-zookeeper.default.svc.cluster.local:2181","clientid":""},{"id":"17ca8ce.d30a173","type":"inject","z":"f2ff6f77.dd264","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":100,"wires":[["7c655885.c88968"]]},{"id":"7c655885.c88968","type":"function","z":"f2ff6f77.dd264","name":"Search Google","func":"/**\n * Copyright 2017 Google Inc. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/**\n * @fileoverview Search developers.google.com/web for articles tagged\n * \"Headless Chrome\" and scrape results from the results page.\n */\n\n'use strict';\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n  const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox']});\n  const page = await browser.newPage();\n\n  await page.goto('https://developers.google.com/web/');\n\n  // Type into search box.\n  await page.type('#searchbox input', 'Headless Chrome');\n\n  // Wait for suggest overlay to appear and click \"show all results\".\n  const allResultsSelector = '.devsite-suggest-all-results';\n  await page.waitForSelector(allResultsSelector);\n  await page.click(allResultsSelector);\n\n  // Wait for the results page to load and display the results.\n  const resultsSelector = '.gsc-results .gsc-thumbnail-inside a.gs-title';\n  await page.waitForSelector(resultsSelector);\n\n  // Extract the results from the page.\n  const links = await page.evaluate(resultsSelector => {\n    const anchors = Array.from(document.querySelectorAll(resultsSelector));\n    return anchors.map(anchor => {\n      const title = anchor.textContent.split('|')[0].trim();\n      return `${title} - ${anchor.href}`;\n    });\n  }, resultsSelector);\n  console.log(links.join('\\n'));\n  \n  await browser.close();\n  \n  msg.payload = links;\n  msg.topic = \"TASK_COMPLETED\";\n  node.send(msg);\n})();","outputs":1,"noerr":0,"x":380,"y":160,"wires":[["99469da6.6aaf"]]},{"id":"99469da6.6aaf","type":"switch","z":"f2ff6f77.dd264","name":"Topic Router","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"TASK_COMPLETED","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":220,"wires":[["97f9ede7.842e4"]]},{"id":"97f9ede7.842e4","type":"debug","z":"f2ff6f77.dd264","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":790,"y":320,"wires":[]},{"id":"933cd808.8c7c18","type":"inject","z":"75754e68.a55af","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":80,"wires":[["58aee25b.1f72fc"]]},{"id":"58aee25b.1f72fc","type":"function","z":"75754e68.a55af","name":"1betpro","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\n//msg.payload = JSON.stringify(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["68e2b44e.9b42dc"]]},{"id":"151d107c.6f1aa","type":"debug","z":"25e0c6e7.7b804a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":930,"y":240,"wires":[]},{"id":"20d8b05a.fe4ba","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":250,"y":160,"wires":[["15533bd8.282f44"]]},{"id":"15533bd8.282f44","type":"function","z":"25e0c6e7.7b804a","name":"query Selectors","func":"'use strict';\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n    const browser = await puppeteer.launch({args: msg.payload.value.browser_args});\n    const page = await browser.newPage();\n    \n    await page.goto(msg.payload.value.url);\n    \n    await page.type(msg.payload.value.username_selector, msg.payload.value.username);\n    await page.type(msg.payload.value.password_selector, msg.payload.value.password);\n    \n    await page.waitForSelector(msg.payload.value.login_button_selector);\n    \n    await page.click(msg.payload.value.login_button_selector);\n    \n    await page.waitForSelector(msg.payload.value.logout_user_selector);\n    \n    await page.goto(msg.payload.value.next_url);\n    \n    await page.waitForSelector(msg.payload.value.wait_for_selector);\n    \n    // Extract the results from the page.\n    const rows = await page.evaluate(results_selector => {\n        \n        //Extract\n        const anchors = Array.from(document.querySelectorAll(results_selector));\n        \n        //Transform\n        return anchors.map((anchor, index, array) => {\n            row = {};\n                \n            if(`${anchor.id}`!==\"\" && index<14){\n                row.fixed_number_of_total_td_in_tr = 10;\n                row.array_length = array.length;\n                \n                row.index = index;\n                row.event_number = Math.floor(row.index/10);\n                \n                row.id = `${anchor.id}`;\n                row.textContent = `${anchor.textContent}`;\n                row.innerHTML = `${anchor.innerHTML}`;\n                row.team_anchor_index = (row.event_number*10);\n                \n                //team_anchor = array[team_anchor_index];\n                \n                //console.log(team_anchor);\n                \n                //row.team_innerHTML = `${team_anchor.innerHTML}`;\n                \n                row.source = anchor;\n                \n                row.elements = row.innerHTML.split(\"</\");\n                //custom transformation\n                row.id_parts = row.id.split(\"_\");\n                row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n                row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n                row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n                row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n                row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n                \n                //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n                //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n                  \n                row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n                \n                row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n                row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n                \n                row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n        \n                row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n                row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n        \n                //console.log(row);\n                \n            }\n            \n            return row;\n            \n        });\n    }, msg.payload.value.results_selector);\n  \n    msg.topic = msg.topic + msg.payload.value.finish_topic_suffix;\n    msg.payload = rows;\n    \n    node.send(msg);\n    //console.log(rows.join('\\n'));\n    //console.log(rows);\n  \n    await browser.close();\n})();","outputs":1,"noerr":0,"x":440,"y":160,"wires":[["6d93887e.c57a98"]]},{"id":"c828717a.8ab8","type":"function","z":"5aa43ca5.797fa4","name":"","func":"\nglobal.toJSON = function toJSON(node) {\n  node = node || this;\n  var obj = {\n    nodeType: node.nodeType\n  };\n  if (node.tagName) {\n    obj.tagName = node.tagName.toLowerCase();\n  } else\n  if (node.nodeName) {\n    obj.nodeName = node.nodeName;\n  }\n  if (node.nodeValue) {\n    obj.nodeValue = node.nodeValue;\n  }\n  var attrs = node.attributes;\n  if (attrs) {\n    var length = attrs.length;\n    var arr = obj.attributes = new Array(length);\n    for (var i = 0; i < length; i++) {\n      attr = attrs[i];\n      arr[i] = [attr.nodeName, attr.nodeValue];\n    }\n  }\n  var childNodes = node.childNodes;\n  if (childNodes) {\n    length = childNodes.length;\n    arr = obj.childNodes = new Array(length);\n    for (i = 0; i < length; i++) {\n      arr[i] = toJSON(childNodes[i]);\n    }\n  }\n  return obj;\n};\n\nglobal.toDOM = function toDOM(obj) {\n  if (typeof obj == 'string') {\n    obj = JSON.parse(obj);\n  }\n  var node, nodeType = obj.nodeType;\n  switch (nodeType) {\n    case 1: //ELEMENT_NODE\n      node = document.createElement(obj.tagName);\n      var attributes = obj.attributes || [];\n      for (var i = 0, len = attributes.length; i < len; i++) {\n        var attr = attributes[i];\n        node.setAttribute(attr[0], attr[1]);\n      }\n      break;\n    case 3: //TEXT_NODE\n      node = document.createTextNode(obj.nodeValue);\n      break;\n    case 8: //COMMENT_NODE\n      node = document.createComment(obj.nodeValue);\n      break;\n    case 9: //DOCUMENT_NODE\n      node = document.implementation.createDocument();\n      break;\n    case 10: //DOCUMENT_TYPE_NODE\n      node = document.implementation.createDocumentType(obj.nodeName);\n      break;\n    case 11: //DOCUMENT_FRAGMENT_NODE\n      node = document.createDocumentFragment();\n      break;\n    default:\n      return node;\n  }\n  if (nodeType == 1 || nodeType == 11) {\n    var childNodes = obj.childNodes || [];\n    for (i = 0, len = childNodes.length; i < len; i++) {\n      node.appendChild(toDOM(childNodes[i]));\n    }\n  }\n  return node;\n};\n\nconst rows = await anchors.forEach((anchor, index, array) => {\n        \n        row = {};\n            \n        if(`${anchor.id}`!==\"\" && index<14){\n            row.fixed_number_of_total_td_in_tr = 10;\n            row.array_length = array.length;\n            \n            row.index = index;\n            row.event_number = Math.floor(row.index/10);\n            \n            row.id = `${anchor.id}`;\n            row.textContent = `${anchor.textContent}`;\n            row.innerHTML = `${anchor.innerHTML}`;\n            row.team_anchor_index = (row.event_number*10);\n            \n            //team_anchor = array[team_anchor_index];\n            \n            //console.log(team_anchor);\n            \n            //row.team_innerHTML = `${team_anchor.innerHTML}`;\n            \n            row.source = anchor;\n            \n            row.elements = row.innerHTML.split(\"</\");\n            //custom transformation\n            row.id_parts = row.id.split(\"_\");\n            row.part0 = (row.id_parts.length > 0) ? row.id_parts[0] : null;\n            row.part1 = (row.id_parts.length > 1) ? row.id_parts[1] : null;\n            row.part2 = (row.id_parts.length > 2) ? row.id_parts[2] : null;\n            row.part3 = (row.id_parts.length > 3) ? row.id_parts[3] : null;\n            row.part4 = (row.id_parts.length > 4) ? row.id_parts[4] : null;\n            \n            //row.team  = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[1].split(\">\")[team_innerHTML.split(\"</\")[1].split(\">\").length-1] : null;\n            //row.score = (team_innerHTML.lenght>0) ? team_innerHTML.split(\"</\")[0].split(\">\")[team_innerHTML.split(\"</\")[0].split(\">\").length-1] : null;\n              \n            row.bet_1x2 = (row.part2===\"02\")? row.textContent : null;\n            \n            row.bet_handicap1 = (row.part2===\"01\")? row.textContent.split(\" \")[0] : null;\n            row.bet_handicap2 = (row.part2===\"01\")? row.textContent.split(\" \")[1] : null;\n            \n            row.bet_over1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[1]  : null;\n            row.bet_over2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"O\")? row.textContent.split(\" \")[2]  : null;\n    \n            row.bet_under1 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[1]  : null;\n            row.bet_under2 = (row.part2===\"03\" && row.textContent.split(\" \")[0]===\"U\")? row.textContent.split(\" \")[2]  : null;\n    \n            console.log(row);\n            \n        }\n        \n        return row;\n        \n    });\n    \nreturn msg;","outputs":1,"noerr":11,"x":270,"y":120,"wires":[[]]},{"id":"68e2b44e.9b42dc","type":"kafka producer","z":"75754e68.a55af","name":"send message","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":480,"y":80,"wires":[]},{"id":"fcf73cfd.bae76","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":90,"y":160,"wires":[["20d8b05a.fe4ba"]]},{"id":"d649ed3b.961c1","type":"function","z":"5aa43ca5.797fa4","name":"Scrape","func":"'use strict';\n\nconst puppeteer = global.get('puppeteer');\n\n(async() => {\n  const browser = await puppeteer.launch({args: ['--no-sandbox', '--disable-setuid-sandbox']});\n  const page = await browser.newPage();\n\n  await page.goto(msg.payload.config.url);\n\n  await page.type(msg.payload.config.username_selector, msg.payload.config.username);\n  await page.type(msg.payload.config.password_selector, msg.payload.config.password);\n\n  await page.waitForSelector(msg.payload.config.login_button_selector);\n  \n  await page.click(msg.payload.config.login_button_selector);\n\n  await page.waitForSelector('#logout_user');\n  \n  await page.goto(\"https://1betpro.com/live/\");\n  \n  await page.waitForSelector('#select_type_bet > a.Active');\n  \n  //node.log(page.title());\n  \n  //const resultsSelector = '.addbetslip';\n  const resultsSelector = 'tr.bets_lines td';\n  // Extract the results from the page.\n  const lines = await page.evaluate(resultsSelector => {\n    const anchors = Array.from(document.querySelectorAll(resultsSelector));\n    return anchors.map((anchor, index, array) => {\n    \n        const fixed_number_of_total_td_in_tr=8;\n        const row_number = Math.floor(index/fixed_number_of_total_td_in_tr);\n        const source = anchor;\n        const uuid = `${anchor.id}`;\n        const textContent = anchor.textContent.trim();\n        \n        var attributes = uuid.split(\"_\");\n        var line = {\n          \"uuid\" : uuid,\n          \"id\" :  attributes[0],\n          \"part1\": attributes[1],\n          \"part2\": attributes[2],\n          \"part3\": attributes[3],\n          \"part4\": attributes[4],\n          \"part5\": attributes[5],\n          \"team\" : team,\n          \"line\": textContent\n          };\n        \n        line.bet_1x2 = (line.part2==\"02\")? textContent : null;\n        line.bet_handicap = (line.part2==\"01\")? textContent.split(\" \")[0] + \"/\" + textContent.split(\" \")[1] : null;\n        line.bet_over = (line.part2==\"03\" && textContent.split(\" \")[0]==\"O\")? textContent.split(\" \")[1] + \"/\" + textContent.split(\" \")[2]  : null;\n        line.bet_under = (line.part2==\"03\" && textContent.split(\" \")[0]==\"U\")? textContent.split(\" \")[1] + \"/\" + textContent.split(\" \")[2]  : null;\n\n        return line;\n    });\n    \n  }, resultsSelector);\n  \n  //console.log(lines.join('\\n'));\n  \n  await browser.close();\n  \n  msg.payload = lines;\n  msg.topic = \"TASK_COMPLETED\";\n  node.send(msg);\n})();","outputs":1,"noerr":0,"x":440,"y":160,"wires":[[]]},{"id":"7ac484b7.34c5fc","type":"kafka producer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":890,"y":160,"wires":[]},{"id":"ec67ce57.5fe5b","type":"kafka consumer","z":"25e0c6e7.7b804a","name":"1betpro_finished","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro_finished","consumerGroupId":"","autoCommit":"","kafkaEncoding":"utf8","x":120,"y":240,"wires":[["2eb771d3.abcbee"]]},{"id":"2eb771d3.abcbee","type":"json","z":"25e0c6e7.7b804a","name":"","property":"payload.value","action":"","pretty":true,"x":310,"y":240,"wires":[["151d107c.6f1aa"]]},{"id":"8e8ed84d.848508","type":"inject","z":"25e0c6e7.7b804a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":80,"wires":[["a0fbec9e.347ae"]]},{"id":"a0fbec9e.347ae","type":"function","z":"25e0c6e7.7b804a","name":"1betpro","func":"msg = {\n    topic : '1betpro',\n    payload : {\n        browser_args: ['--no-sandbox', '--disable-setuid-sandbox'],\n        url: 'https://1betpro.com/',\n        username: 'Tal1234',\n        password: '1111',\n        username_selector: '#form > div:nth-child(2) > input',\n        password_selector: '#form > div:nth-child(3) > input',\n        login_button_selector: '#form > input',\n        logout_user_selector: '#logout_user',\n        next_url: 'https://1betpro.com/live/',\n        wait_for_selector: '#select_type_bet > a.Active',\n        results_selector : 'tr.bets_lines td',\n        finish_topic_suffix : \"_finished\",\n        _time : msg.payload,\n        time  : new Date(msg.payload).toISOString()\n    }\n}\n\n//msg.payload = JSON.stringify(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":80,"wires":[["c0854aa1.d7d978"]]},{"id":"c0854aa1.d7d978","type":"kafka producer","z":"25e0c6e7.7b804a","name":"send message","zk":"zookeeper-zookeeper.default.svc.cluster.local:2181","topics":"1betpro","kafkaClientId":"","zkSessionTimeout":"","zkSpinDelay":"","zkRetries":"","noAckBatchSize":"","noAckBatchAge":"","requireAcks":"","ackTimeoutMs":"","partitionerType":"","x":900,"y":80,"wires":[]},{"id":"6d93887e.c57a98","type":"switch","z":"25e0c6e7.7b804a","name":"1betpro_finished","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1betpro_finished","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":160,"wires":[["7ac484b7.34c5fc"]]}]